## Codebase Patterns
- Use `uv run mypy src/` to typecheck the project
- All functions must have return type annotations for strict mypy
- Database module is at `src/booktok/database.py` with `initialize_database()` function
- Use `uv sync` and `uv add` for dependency management
- Data models are in `src/booktok/models.py` with enums: BookStatus, FileType, Frequency
- All dataclasses have `validate()` method and call it in `__post_init__()`
- Repository pattern: use `DatabaseConnectionManager` from `src/booktok/repository.py`
- Use `with db.transaction()` context manager for write operations (auto commit/rollback)
- SQLite stores booleans as INTEGER (0/1) - convert when reading rows
- ebooklib lacks type stubs - mypy override for "ebooklib.*" is in pyproject.toml
- nltk lacks type stubs - mypy override for "nltk.*" is in pyproject.toml
- Book text extraction is in `src/booktok/book_processor.py` with BookProcessor class
- Use `process_book_safely()` for safe processing with error handling and status updates
- ProcessingResult dataclass provides structured success/error responses with user messages
- Snippet generation in `src/booktok/snippet_generator.py` with SnippetGenerator class
- Use `generate_snippets_safely()` for safe snippet generation with error handling
- Clear mypy cache with `rm -rf .mypy_cache` if pyproject.toml mypy config changes aren't picked up

---

## 2026-01-10 - US-001
Thread: https://ampcode.com/threads/T-019ba8e3-1cce-72a9-877a-200b1a225c86
- What was implemented:
  - Updated pyproject.toml with all required dependencies
  - Created SQLite database initialization script with full schema
  - Fixed main.py to have proper type annotations
- Files changed:
  - pyproject.toml - Added dependencies and mypy config
  - src/booktok/database.py - New file with database initialization
  - src/main.py - Added return type annotation
- **Learnings for future iterations:**
  - Project uses strict mypy configuration - all functions need type annotations
  - Database schema includes: users, books, snippets, user_progress, delivery_schedules
  - Tables use INTEGER for booleans (is_completed, is_paused)
---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/T-019ba8e5-1636-73eb-a6be-37164bcce51c
- What was implemented:
  - Created data model dataclasses for User, Book, Snippet, UserProgress, DeliverySchedule
  - Added enums for BookStatus, FileType, and Frequency
  - Implemented validate() method for each dataclass
  - All models use __post_init__ for automatic validation
- Files changed:
  - src/booktok/models.py - New file with all data models
- **Learnings for future iterations:**
  - Use Enum types for constrained choices (BookStatus, FileType, Frequency)
  - ValidationError is a custom exception in models.py
  - delivery_time format is "HH:MM" (24-hour format)
  - Database IDs are Optional[int] since they're set by DB on insert
---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/T-019ba8e6-aecb-73e2-9e15-b9ec393af3c5
- What was implemented:
  - Created DatabaseConnectionManager with context manager for transactions
  - Implemented UserRepository with full CRUD + get_by_telegram_id
  - Implemented BookRepository with CRUD + list_by_status
  - Implemented SnippetRepository with CRUD + bulk create, get_by_book_and_position
  - Implemented UserProgressRepository with CRUD + get_by_user_and_book
  - Implemented DeliveryScheduleRepository with CRUD + list_pending_deliveries
  - Created MigrationManager for database version tracking
- Files changed:
  - src/booktok/repository.py - New file with all repositories
- **Learnings for future iterations:**
  - All repositories use DatabaseConnectionManager for shared connection handling
  - Use `with db.transaction()` for write operations (auto commit/rollback)
  - SQLite stores booleans as INTEGER (0/1) - convert in row_to_model methods
  - datetime values stored as ISO format strings, parse with fromisoformat()
  - MigrationManager tracks applied migrations in `migrations` table
---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/T-019ba8e9-8dfb-7368-93a9-69385ec26836
- What was implemented:
  - Created BookProcessor class with PDF text extraction using PyPDF2
  - Implemented multi-page PDF handling with page-by-page extraction
  - Text cleaning/normalization (whitespace, line breaks, hyphenation fix)
  - Custom exceptions: BookProcessingError, InvalidFileError, UnsupportedFileTypeError
  - Updated __init__.py to export new classes
- Files changed:
  - src/booktok/book_processor.py - New file with PDF extraction logic
  - src/booktok/__init__.py - Added exports for book processor classes
- **Learnings for future iterations:**
  - PyPDF2 uses PdfReader class (not PdfFileReader in v3+)
  - PdfReadError is in PyPDF2.errors module
  - Image-based PDFs won't yield text - need to detect and report this
  - Hyphenation across lines is handled by regex: r"(\w)-\s*\n\s*(\w)" -> r"\1\2"
---

## 2026-01-10 - US-005
Thread: https://ampcode.com/threads/T-019ba8eb-4b56-726a-922f-d9b69a7d1edc
- What was implemented:
  - Extended BookProcessor with EPUB text extraction using ebooklib
  - Added BeautifulSoup for HTML parsing of EPUB content
  - Strips script/style tags, extracts text with proper separator
  - Error handling for invalid/corrupted EPUBs (catches EpubException)
  - Uses same _clean_and_normalize_text method as PDF for consistency
- Files changed:
  - src/booktok/book_processor.py - Added _extract_epub_text method, updated imports
  - pyproject.toml - Added beautifulsoup4 dependency, mypy override for ebooklib
  - uv.lock - Updated with new dependency
- **Learnings for future iterations:**
  - ebooklib lacks type stubs - need mypy override in pyproject.toml
  - Use `epub.read_epub(path, options={"ignore_ncx": True})` to avoid NCX parsing issues
  - EPUB items of type ITEM_DOCUMENT contain the readable content
  - BeautifulSoup `get_text(separator="\n")` preserves paragraph structure
---

## 2026-01-10 - US-006
Thread: https://ampcode.com/threads/T-019ba8ee-9d53-754d-b58d-096f8e424a74
- What was implemented:
  - Added file validation before processing (size limits, magic byte checks)
  - Created ProcessingResult dataclass for structured error responses
  - Added validate_file() method with comprehensive checks
  - Implemented process_book_safely() method with full error handling
  - Added _mark_as_failed() to set BookStatus.FAILED on errors
  - All errors logged with details (exc_info=True)
  - User-friendly error messages returned via ProcessingResult
- Files changed:
  - src/booktok/book_processor.py - Added validation, ProcessingResult, safe processing
  - src/booktok/__init__.py - Exported ProcessingResult
- **Learnings for future iterations:**
  - PDF files start with b"%PDF" magic bytes
  - EPUB files are ZIP archives (start with b"PK\x03\x04")
  - Use ProcessingResult for safe processing with user-friendly error messages
  - process_book_safely() handles all exceptions and updates book status
  - File size limits: MIN=100 bytes, MAX=100MB
---

## 2026-01-10 - US-007
Thread: https://ampcode.com/threads/T-019ba8f1-b1ae-7100-ac54-25e5cf477125
- What was implemented:
  - Created SnippetGenerator class with NLTK integration for text processing
  - Implemented paragraph boundary detection using double-newline splitting
  - Snippets extracted as 1-2 paragraph chunks based on target length (800 chars)
  - Sequential position markers (0-indexed) assigned to each snippet
  - Snippet objects created with book_id and position metadata
  - Added generate_snippets_safely() with SnippetGenerationResult for error handling
  - Added NLTK punkt_tab tokenizer auto-download for sentence detection
- Files changed:
  - src/booktok/snippet_generator.py - New file with SnippetGenerator class
  - src/booktok/__init__.py - Exported SnippetGenerator, SnippetGenerationError, SnippetGenerationResult
  - pyproject.toml - Added mypy override for nltk module
- **Learnings for future iterations:**
  - nltk lacks type stubs - need mypy override in pyproject.toml
  - Use `nltk.data.find("tokenizers/punkt_tab")` to check if data exists before download
  - Paragraph detection: split on `\n\s*\n` regex, filter paragraphs < 20 chars
  - Snippet constants: MIN_LENGTH=100, MAX_LENGTH=3500, TARGET_LENGTH=800
  - Clear mypy cache if pyproject.toml config changes aren't picked up
- Snippet formatting is in `src/booktok/snippet_formatter.py` with SnippetFormatter class
- Telegram message limit is 4096 chars; use HEADER_RESERVE=200 for safe content
- Use `validate_message_length()` utility function to check message lengths
---

## 2026-01-10 - US-008
Thread: https://ampcode.com/threads/T-019ba8f5-d61e-764e-addf-06966835de02
- What was implemented:
  - Created SnippetFormatter class for Telegram message formatting
  - Implemented FormattedMessage and FormattedSnippet dataclasses
  - Message length validation against Telegram 4096 char limit
  - Long snippet splitting across multiple messages with continuation markers
  - Header with book title, author (with emoji), and progress indicator
  - Markdown escaping for special characters
  - Paragraph break formatting for clean display
- Files changed:
  - src/booktok/snippet_formatter.py - New file with formatter logic
  - src/booktok/__init__.py - Added exports for formatter classes
- **Learnings for future iterations:**
  - TELEGRAM_MAX_MESSAGE_LENGTH = 4096 chars per message
  - Reserve 200 chars for header when calculating safe content length
  - Split at paragraph boundaries first, then sentence boundaries, then word
  - Use emojis: ðŸ“š for book title, âœï¸ for author, ðŸ“– for progress
  - Escape Markdown special chars: _ * [ ] ( ) ~ ` > # + - = | { } . !
---
